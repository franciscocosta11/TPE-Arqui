#include <videoDriver.h>
#include <stdint.h>

unsigned char font[256][16] = {
    [' '] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    ['A'] = {0x00,0x18,0x3C,0x3C,0x66,0x66,0x7E,0x7E,0x66,0x66,0x66,0x66,0x00,0x00,0x00,0x00},
    ['B'] = {0x00,0x7C,0x66,0x66,0x7C,0x66,0x66,0x66,0x66,0x66,0x7C,0x00,0x00,0x00,0x00,0x00},
    ['C'] = {0x00,0x3C,0x66,0x60,0x60,0x60,0x60,0x60,0x60,0x66,0x3C,0x00,0x00,0x00,0x00,0x00},
    ['D'] = {0x00,0x7C,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x7C,0x00,0x00,0x00,0x00,0x00},
    ['E'] = {0x00,0x7E,0x60,0x60,0x60,0x7C,0x60,0x60,0x60,0x60,0x7E,0x00,0x00,0x00,0x00,0x00},
    ['F'] = {0x00,0x7E,0x60,0x60,0x60,0x7C,0x60,0x60,0x60,0x60,0x60,0x00,0x00,0x00,0x00,0x00},
    ['G'] = {0x00,0x3C,0x66,0x60,0x60,0x6E,0x66,0x66,0x66,0x66,0x3E,0x00,0x00,0x00,0x00,0x00},
    ['H'] = {0x00,0x66,0x66,0x66,0x66,0x7E,0x66,0x66,0x66,0x66,0x66,0x00,0x00,0x00,0x00,0x00},
    ['I'] = {0x00,0x3C,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00,0x00},
    ['J'] = {0x00,0x1E,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x6C,0x38,0x00,0x00,0x00,0x00,0x00},
    ['K'] = {0x00,0x66,0x66,0x6C,0x6C,0x78,0x78,0x6C,0x66,0x66,0x66,0x00,0x00,0x00,0x00,0x00},
    ['L'] = {0x00,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x7E,0x00,0x00,0x00,0x00,0x00},
    ['M'] = {0x00,0x63,0x77,0x7F,0x6B,0x63,0x63,0x63,0x63,0x63,0x63,0x00,0x00,0x00,0x00,0x00},
    ['N'] = {0x00,0x63,0x73,0x7B,0x7F,0x6F,0x67,0x63,0x63,0x63,0x63,0x00,0x00,0x00,0x00,0x00},
    ['O'] = {0x00,0x3C,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x3C,0x00,0x00,0x00,0x00,0x00},
    ['P'] = {0x00,0x7C,0x66,0x66,0x66,0x7C,0x60,0x60,0x60,0x60,0x60,0x00,0x00,0x00,0x00,0x00},
    ['S'] = {0x00,0x3C,0x66,0x66,0x60,0x38,0x0C,0x06,0x66,0x66,0x3C,0x00,0x00,0x00,0x00,0x00},
    ['T'] = {0x00,0x7E,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x00,0x00,0x00,0x00,0x00},
    ['i'] = {0x00,0x00,0x18,0x18,0x00,0x18,0x18,0x18,0x18,0x18,0x18,0x00,0x00,0x00,0x00,0x00},
    ['n'] = {0x00,0x00,0x00,0x00,0x6C,0x76,0x66,0x66,0x66,0x66,0x66,0x00,0x00,0x00,0x00,0x00},
    ['a'] = {0x00,0x00,0x00,0x00,0x3C,0x06,0x3E,0x66,0x66,0x66,0x3E,0x00,0x00,0x00,0x00,0x00},
    ['l'] = {0x00,0x38,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00,0x00},
    ['z'] = {0x00,0x00,0x00,0x00,0x7E,0x66,0x0C,0x18,0x30,0x66,0x7E,0x00,0x00,0x00,0x00,0x00},
    ['d'] = {0x00,0x06,0x06,0x06,0x3E,0x66,0x66,0x66,0x66,0x66,0x3E,0x00,0x00,0x00,0x00,0x00},
    ['o'] = {0x00,0x00,0x00,0x00,0x3C,0x66,0x66,0x66,0x66,0x66,0x3C,0x00,0x00,0x00,0x00,0x00},
    ['.'] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00},
    [':'] = {0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00},
    ['0'] = {0x00,0x3C,0x66,0x6E,0x7E,0x76,0x66,0x66,0x66,0x66,0x3C,0x00,0x00,0x00,0x00,0x00},
    ['1'] = {0x00,0x18,0x38,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x7E,0x00,0x00,0x00,0x00,0x00},
    ['2'] = {0x00,0x3C,0x66,0x06,0x0C,0x18,0x30,0x60,0x60,0x66,0x7E,0x00,0x00,0x00,0x00,0x00},
    ['3'] = {0x00,0x3C,0x66,0x06,0x06,0x1C,0x06,0x06,0x06,0x66,0x3C,0x00,0x00,0x00,0x00,0x00},
    ['4'] = {0x00,0x0C,0x1C,0x3C,0x6C,0x6C,0x7E,0x0C,0x0C,0x0C,0x0C,0x00,0x00,0x00,0x00,0x00},
    ['5'] = {0x00,0x7E,0x60,0x60,0x60,0x7C,0x06,0x06,0x06,0x66,0x3C,0x00,0x00,0x00,0x00,0x00},
    ['6'] = {0x00,0x3C,0x66,0x60,0x60,0x7C,0x66,0x66,0x66,0x66,0x3C,0x00,0x00,0x00,0x00,0x00},
    ['7'] = {0x00,0x7E,0x66,0x06,0x0C,0x18,0x18,0x18,0x18,0x18,0x18,0x00,0x00,0x00,0x00,0x00},
    ['8'] = {0x00,0x3C,0x66,0x66,0x66,0x3C,0x66,0x66,0x66,0x66,0x3C,0x00,0x00,0x00,0x00,0x00},
    ['9'] = {0x00,0x3C,0x66,0x66,0x66,0x66,0x3E,0x06,0x06,0x66,0x3C,0x00,0x00,0x00,0x00,0x00},
    ['\n'] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    ['\b'] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    [' '] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	['Q'] = {0x00,0x3C,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x6E,0x3C,0x0E,0x00,0x00,0x00,0x00},
	['R'] = {0x00,0x7C,0x66,0x66,0x66,0x7C,0x78,0x6C,0x66,0x66,0x66,0x00,0x00,0x00,0x00,0x00},
	['U'] = {0x00,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x3C,0x00,0x00,0x00,0x00,0x00},
	['V'] = {0x00,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x3C,0x3C,0x18,0x00,0x00,0x00,0x00,0x00},
	['W'] = {0x00,0x63,0x63,0x63,0x63,0x63,0x6B,0x6B,0x7F,0x3E,0x36,0x00,0x00,0x00,0x00,0x00},
	['X'] = {0x00,0x66,0x66,0x66,0x3C,0x18,0x18,0x3C,0x66,0x66,0x66,0x00,0x00,0x00,0x00,0x00},
	['Y'] = {0x00,0x66,0x66,0x66,0x66,0x3C,0x18,0x18,0x18,0x18,0x18,0x00,0x00,0x00,0x00,0x00},
	['Z'] = {0x00,0x7E,0x06,0x0C,0x18,0x30,0x30,0x18,0x0C,0x06,0x7E,0x00,0x00,0x00,0x00,0x00},

	['b'] = {0x00,0x60,0x60,0x60,0x7C,0x66,0x66,0x66,0x66,0x66,0x7C,0x00,0x00,0x00,0x00,0x00},
	['c'] = {0x00,0x00,0x00,0x00,0x3C,0x66,0x60,0x60,0x60,0x66,0x3C,0x00,0x00,0x00,0x00,0x00},
	['e'] = {0x00,0x00,0x00,0x00,0x3C,0x66,0x66,0x7E,0x60,0x66,0x3C,0x00,0x00,0x00,0x00,0x00},
	['f'] = {0x00,0x1C,0x36,0x30,0x30,0x7C,0x30,0x30,0x30,0x30,0x30,0x00,0x00,0x00,0x00,0x00},
	['g'] = {0x00,0x00,0x00,0x00,0x3E,0x66,0x66,0x66,0x3E,0x06,0x66,0x3C,0x00,0x00,0x00,0x00},
	['h'] = {0x00,0x60,0x60,0x60,0x7C,0x66,0x66,0x66,0x66,0x66,0x66,0x00,0x00,0x00,0x00,0x00},
	['j'] = {0x00,0x00,0x18,0x18,0x00,0x38,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
	['k'] = {0x00,0x60,0x60,0x60,0x66,0x6C,0x78,0x78,0x6C,0x66,0x66,0x00,0x00,0x00,0x00,0x00},
	['m'] = {0x00,0x00,0x00,0x00,0x63,0x77,0x7F,0x6B,0x63,0x63,0x63,0x00,0x00,0x00,0x00,0x00},
	['p'] = {0x00,0x00,0x00,0x00,0x7C,0x66,0x66,0x66,0x7C,0x60,0x60,0x60,0x00,0x00,0x00,0x00},
	['q'] = {0x00,0x00,0x00,0x00,0x3E,0x66,0x66,0x66,0x3E,0x06,0x06,0x06,0x00,0x00,0x00,0x00},
	['r'] = {0x00,0x00,0x00,0x00,0x6C,0x76,0x60,0x60,0x60,0x60,0x60,0x00,0x00,0x00,0x00,0x00},
	['s'] = {0x00,0x00,0x00,0x00,0x3E,0x60,0x60,0x3C,0x06,0x06,0x7C,0x00,0x00,0x00,0x00,0x00},
	['t'] = {0x00,0x00,0x30,0x30,0x7C,0x30,0x30,0x30,0x30,0x36,0x1C,0x00,0x00,0x00,0x00,0x00},
	['u'] = {0x00,0x00,0x00,0x00,0x66,0x66,0x66,0x66,0x66,0x66,0x3E,0x00,0x00,0x00,0x00,0x00},
	['v'] = {0x00,0x00,0x00,0x00,0x66,0x66,0x66,0x66,0x66,0x3C,0x18,0x00,0x00,0x00,0x00,0x00},
	['w'] = {0x00,0x00,0x00,0x00,0x63,0x63,0x63,0x6B,0x7F,0x3E,0x36,0x00,0x00,0x00,0x00,0x00},
	['x'] = {0x00,0x00,0x00,0x00,0x66,0x66,0x3C,0x18,0x3C,0x66,0x66,0x00,0x00,0x00,0x00,0x00},
	['y'] = {0x00,0x00,0x00,0x00,0x66,0x66,0x66,0x66,0x3E,0x06,0x66,0x3C,0x00,0x00,0x00,0x00},

	['!'] = {0x00,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x00,0x00,0x18,0x00,0x00,0x00,0x00,0x00},
	['@'] = {0x00,0x3C,0x66,0x6E,0x6A,0x6A,0x6E,0x60,0x60,0x66,0x3C,0x00,0x00,0x00,0x00,0x00},
	['#'] = {0x00,0x36,0x36,0x36,0x7F,0x36,0x36,0x36,0x7F,0x36,0x36,0x00,0x00,0x00,0x00,0x00},
	['$'] = {0x00,0x18,0x3E,0x60,0x60,0x3C,0x06,0x06,0x7C,0x18,0x18,0x00,0x00,0x00,0x00,0x00},
	['%'] = {0x00,0x00,0x66,0x66,0x0C,0x18,0x30,0x60,0x66,0x66,0x00,0x00,0x00,0x00,0x00,0x00},
	['^'] = {0x00,0x18,0x3C,0x66,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	['&'] = {0x00,0x38,0x6C,0x6C,0x38,0x76,0x6E,0x66,0x66,0x6E,0x3C,0x00,0x00,0x00,0x00,0x00},
	['*'] = {0x00,0x00,0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	['('] = {0x00,0x0C,0x18,0x30,0x30,0x30,0x30,0x30,0x30,0x18,0x0C,0x00,0x00,0x00,0x00,0x00},
	[')'] = {0x00,0x30,0x18,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x18,0x30,0x00,0x00,0x00,0x00,0x00},
	['_'] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7F,0x00,0x00,0x00,0x00,0x00},
	['+'] = {0x00,0x00,0x00,0x18,0x18,0x7E,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	['='] = {0x00,0x00,0x00,0x00,0x7E,0x00,0x7E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	['['] = {0x00,0x3C,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x3C,0x00,0x00,0x00,0x00,0x00},
	[']'] = {0x00,0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C,0x00,0x00,0x00,0x00,0x00},
	['{'] = {0x00,0x0E,0x18,0x18,0x18,0x70,0x18,0x18,0x18,0x18,0x0E,0x00,0x00,0x00,0x00,0x00},
	['}'] = {0x00,0x70,0x18,0x18,0x18,0x0E,0x18,0x18,0x18,0x18,0x70,0x00,0x00,0x00,0x00,0x00},
	['|'] = {0x00,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x00,0x00,0x00,0x00,0x00},
	['\\'] = {0x00,0x60,0x60,0x30,0x30,0x18,0x18,0x0C,0x0C,0x06,0x06,0x00,0x00,0x00,0x00,0x00},
	[';'] = {0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x18,0x18,0x18,0x30,0x00,0x00,0x00,0x00,0x00},
	['\''] = {0x00,0x18,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	['"'] = {0x00,0x66,0x66,0x66,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	[','] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x18,0x30,0x00,0x00,0x00,0x00,0x00},
	['<'] = {0x00,0x06,0x0C,0x18,0x30,0x60,0x60,0x30,0x18,0x0C,0x06,0x00,0x00,0x00,0x00,0x00},
	['>'] = {0x00,0x60,0x30,0x18,0x0C,0x06,0x06,0x0C,0x18,0x30,0x60,0x00,0x00,0x00,0x00,0x00},
	['?'] = {0x00,0x3C,0x66,0x06,0x0C,0x18,0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00},
	['/'] = {0x00,0x06,0x06,0x0C,0x0C,0x18,0x18,0x30,0x30,0x60,0x60,0x00,0x00,0x00,0x00,0x00}
};


struct vbe_mode_info_structure {
    uint16_t attributes;		// deprecated, only bit 7 should be of interest to you, and it indicates the mode supports a linear frame buffer.
    uint8_t window_a;			// deprecated
    uint8_t window_b;			// deprecated
    uint16_t granularity;		// deprecated; used while calculating bank numbers
    uint16_t window_size;
    uint16_t segment_a;
    uint16_t segment_b;
    uint32_t win_func_ptr;		// deprecated; used to switch banks from protected mode without returning to real mode
    uint16_t pitch;			// number of bytes per horizontal line
    uint16_t width;			// width in pixels
    uint16_t height;			// height in pixels
    uint8_t w_char;			// unused...
    uint8_t y_char;			// ...
    uint8_t planes;
    uint8_t bpp;			// bits per pixel in this mode
    uint8_t banks;			// deprecated; total number of banks in this mode
    uint8_t memory_model;
    uint8_t bank_size;		// deprecated; size of a bank, almost always 64 KB but may be 16 KB...
    uint8_t image_pages;
    uint8_t reserved0;
 
    uint8_t red_mask;
    uint8_t red_position;
    uint8_t green_mask;
    uint8_t green_position;
    uint8_t blue_mask;
    uint8_t blue_position;
    uint8_t reserved_mask;
    uint8_t reserved_position;
    uint8_t direct_color_attributes;
 
    uint32_t framebuffer;		// physical address of the linear frame buffer; write here to draw to the screen
    uint32_t off_screen_mem_off;
    uint16_t off_screen_mem_size;	// size of memory in the framebuffer but not being displayed on the screen
    uint8_t reserved1[206];
} __attribute__ ((packed));

typedef struct vbe_mode_info_structure * VBEInfoPtr;

VBEInfoPtr VBE_mode_info = (VBEInfoPtr) 0x0000000000005C00;

// Variables globales para manejar el cursor y el estilo de fuente
static uint16_t cursorX = 0;
static uint16_t cursorY = 0;
static uint32_t defaultFgColor = 0xFFFFFF; // Blanco
static uint32_t defaultBgColor = 0x000000; // Negro

// Fuentes (se definirán en otro archivo)
extern unsigned char font[][16];

void putPixel(uint32_t hexColor, uint64_t x, uint64_t y) {
    uint8_t * framebuffer = (uint8_t *) VBE_mode_info->framebuffer;
    uint64_t offset = (x * ((VBE_mode_info->bpp)/8)) + (y * VBE_mode_info->pitch);
    framebuffer[offset]     =  (hexColor) & 0xFF;
    framebuffer[offset+1]   =  (hexColor >> 8) & 0xFF; 
    framebuffer[offset+2]   =  (hexColor >> 16) & 0xFF;
}

unsigned char *getCharHexData(uint8_t c) {
    return font[c];
}

// Imprime un carácter con los colores por defecto
void vdPrintChar(char character) {
    vdPrintCharStyled(character, defaultFgColor, defaultBgColor);
}

// Imprime una cadena con los colores por defecto
void vdPrint(const char *string) {
    vdPrintStyled((char*)string, defaultFgColor, defaultBgColor);
}

uint64_t vdPrintCharStyled(char character, uint32_t color, uint32_t bgColor) {
    uint8_t fontWidth = WIDTH_S;
    uint8_t fontHeight = HEIGHT_S;
   
    unsigned char* charData = getCharHexData(character);
       
    if (character == '\n') {
        vdNewline();
        return 0;
    }
   
    if (character == '\b') {
        vdDelete();
        return 0;
    }
   
    // Verificar si necesitamos hacer un salto de línea
    if (cursorX + fontWidth >= SCREEN_WIDTH_PIXELS) {
        vdNewline();
    }
   
    // Dibujar el carácter pixel por pixel
    for (uint8_t y = 0; y < fontHeight; y++) {
        for (uint8_t x = 0; x < fontWidth; x++) {
            uint8_t row = charData[y];
            uint8_t isSet = row & (1 << (fontWidth - 1 - x));
            uint32_t pixelColor = isSet ? color : bgColor;
           
            putPixel(pixelColor, cursorX + x, cursorY + y);
        }
    }
   
    // Mover el cursor a la derecha
    cursorX += fontWidth;
   
    return fontWidth;
}

// Imprime una cadena con colores personalizados
void vdPrintStyled(char *s, uint32_t color, uint32_t bgColor) {
    while (*s != 0) {
        vdPrintCharStyled(*s, color, bgColor);
        s++;
    }
}


// Imprime N caracteres de una cadena con colores personalizados
uint64_t vdNPrintStyled(const char *string, uint32_t color, uint32_t bgColor, uint64_t N) {
    uint64_t count = 0;
   
    for (uint64_t i = 0; i < N && string[i] != 0; i++) {
        count += vdPrintCharStyled(string[i], color, bgColor);
    }
   
    return count;
}


// Realiza un salto de línea
void vdNewline() {
    cursorX = 0;
    cursorY += HEIGHT_S;
    
    if (cursorY + HEIGHT_S >= SCREEN_HEIGHT_PIXELS) {
        vdClear(); 
    }
}


// Limpia la pantalla y reinicia el cursor
void vdClear() {
    drawRectangle(defaultBgColor, 0, 0, SCREEN_WIDTH_PIXELS, SCREEN_HEIGHT_PIXELS);
    cursorX = 0;
    cursorY = 0;
}

void vdDelete() {
    uint8_t fontWidth = WIDTH_S;
    uint8_t fontHeight = HEIGHT_S;
    
    if (cursorX >= fontWidth) {
        cursorX -= fontWidth;
        
        // Borrar el carácter anterior dibujando un rectángulo con el color de fondo
        for (uint8_t y = 0; y < fontHeight; y++) {
            for (uint8_t x = 0; x < fontWidth; x++) {
                putPixel(defaultBgColor, cursorX + x, cursorY + y);
            }
        }
    }
}

// Dibuja un rectángulo con un color específico
void drawRectangle(uint32_t color, uint16_t up_l_x, uint16_t up_l_y, uint16_t lo_r_x, uint16_t lo_r_y) {
    for (uint16_t y = up_l_y; y < lo_r_y; y++) {
        for (uint16_t x = up_l_x; x < lo_r_x; x++) {
            putPixel(color, x, y);
        }
    }
}